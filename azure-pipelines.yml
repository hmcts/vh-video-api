# Set variables once
variables:
  solutionType: DotNetCore # angularDotNetCore, dotNetCore, angular
  apiDirectory: 'VideoAPI/Video.API'
  sonarCloudExtraProperties: |
    sonar.cs.opencover.reportsPaths=$(Common.TestResultsDirectory)\Coverage\coverage.opencover.xml
    sonar.coverage.exclusions="**/Program.cs,**/Startup.cs,Builders/**,Configuration/**,ApplicationLogger.cs,BadRequestTelemetry.cs,EnumExtensions.cs,**/AzureTokenProvider.cs,Mappings/**,SeedData/**,VideoDbContext.cs,DesignTimeHearingsContextFactory.cs,Extensions/**,Swagger/**,ConfigureServicesExtensions.cs,Migrations/**,Ddd/**,Validations/**"
    sonar.cpd.exclusions="**/Program.cs,**/Startup.cs,Video.DAL/Mappings/**,Migrations/**,SeedData/**,DesignTimeHearingsContextFactory.cs,Ddd/**,Testing.Common/**,Video.API/ConfigureServicesExtensions.cs,Video.API/Extensions/**,Video.API/Swagger/**,Video.Common/**"
  coverletCoverageExclusions: '"\"[VideoApi.*Tests?]*,[Video.API]Startup,[*]VideoApi.DAL.SeedData.*,[*]VideoApi.DAL.Migrations.*,[*]VideoApi.DAL.Mappings.*,[VideoApi.DAL]Bookings.DAL.VideoApiDbContext,[VideoApi.DAL]Bookings.DAL.DesignTimeHearingsContextFactory,[VideoApi.Common]*,[Testing.Common]*\""'
  integrationTestsAppSettingsTransform: '
    "AzureAd/TenantId":"$(tenantid)",
    "AzureAd/VhVideoApiResourceId":"$(vh-video-api-identifieruris)",
    "Testing/TestClientId":"$(vh-admin-web-appid)",
    "Testing/TestClientSecret":"$(vh-admin-web-key)"
    '
  dalWorkingDirectory: 'VideoAPI/VideoApi.DAL'
  keyVaultName: vhcoreinfrahtdev # Used to get secrets for integration tests
  secretsFilter: 'vh-admin-web-appid,vh-admin-web-key,tenantid,vh-video-api-identifieruris' # filters out secrets returned from key vault

# GitHub Repo that conatins build templates. Reference https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=vsts#using-other-repositories
resources:
  repositories:
  - repository: azureDevOpsTemplates
    type: github
    name: hmcts/azure-devops-templates
    ref: refs/heads/master # ref name to use, defaults to 'refs/heads/master'
    endpoint: 'GitHubDevOps'

trigger:
- master
pr:
- master

jobs:
  
- template: jobs/angularDotNetCore.yml@azureDevOpsTemplates # Template reference
  parameters:
    sonarCloudExtraProperties: $(sonarCloudExtraProperties)
    integrationTestsAppSettingsTransform: $(integrationTestsAppSettingsTransform)
    coverletCoverageExclusions: $(coverletCoverageExclusions)
    apiDirectory: $(apiDirectory)
    dalWorkingDirectory: $(dalWorkingDirectory)
    keyVaultName: $(keyVaultName)
    secretsFilter: $(secretsFilter)